name: Update NSFW Rules

on:
  schedule:
    # 每天早上8点UTC运行 (北京时间16点)
    - cron: '0 8 * * *'
  workflow_dispatch: # 允许手动触发
  push:
    branches: [ main, master ]
    paths:
      - 'convert_abp_to_surge.py'
      - '.github/workflows/update-nsfw-rules.yml'

jobs:
  update-rules:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip

    - name: Generate NSFW rules
      run: |
        python convert_abp_to_surge.py > nsfw_rules.list

    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "检测到文件变更"
          git status --porcelain
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "没有文件变更"
        fi

    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

        # 添加所有变更的文件
        git add nsfw_rules.list

        # 获取最新的提交信息作为参考
        LATEST_COMMIT=$(git log -1 --pretty=format:"%s")

        # 生成新的提交信息
        NEW_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        git commit -m "Auto-update NSFW rules - $NEW_DATE"

        # 推送到当前分支
        git push

    - name: Create issue on failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          const date = new Date().toISOString();
          const runUrl = context.payload.workflow_run?.html_url || 'N/A';

          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'NSFW规则自动更新失败',
            body: 'NSFW规则自动更新工作流执行失败。\\n\\n**运行详情:** ' + runUrl + '\\n\\n**时间:** ' + date,
            labels: ['bug', 'automated']
          })
