name: Update NSFW Rules

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š8ç‚¹UTCè¿è¡Œ (åŒ—äº¬æ—¶é—´16ç‚¹)
    - cron: '0 8 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main, master ]
    paths:
      - 'convert_abp_to_surge.py'
      - '.github/workflows/update-nsfw-rules.yml'

jobs:
  update-rules:
    runs-on: ubuntu-latest

    permissions:
      contents: write    # å…è®¸æ¨é€ä»£ç 

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ä¾¿æäº¤

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip

    - name: Generate NSFW rules
      run: |
        python convert_abp_to_surge.py > nsfw_rules.list

    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          git status --porcelain
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ–‡ä»¶å˜æ›´"
        fi

    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        echo "å¼€å§‹æäº¤å’Œæ¨é€å˜æ›´..."

        # é…ç½®gitç”¨æˆ·ä¿¡æ¯
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

        # æ˜¾ç¤ºå½“å‰çŠ¶æ€
        echo "å½“å‰åˆ†æ”¯: $(git branch --show-current)"
        echo "å˜æ›´æ–‡ä»¶:"
        git status --porcelain

        # æ·»åŠ å˜æ›´çš„æ–‡ä»¶
        git add nsfw_rules.list

        # ç”Ÿæˆæ–°çš„æäº¤ä¿¡æ¯
        NEW_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        COMMIT_MSG="Auto-update NSFW rules - $NEW_DATE"

        echo "æäº¤ä¿¡æ¯: $COMMIT_MSG"

        # æäº¤å˜æ›´
        if git commit -m "$COMMIT_MSG"; then
          echo "æäº¤æˆåŠŸï¼Œå¼€å§‹æ¨é€..."
          # æ¨é€åˆ°å½“å‰åˆ†æ”¯
          if git push origin HEAD; then
            echo "æ¨é€æˆåŠŸï¼"
          else
            echo "æ¨é€å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"
            git log --oneline -5
            exit 1
          fi
        else
          echo "æäº¤å¤±è´¥"
          exit 1
        fi

    - name: Log failure details
      if: failure()
      run: |
        echo "âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥"
        echo "ğŸ•’ å¤±è´¥æ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ”— è¿è¡Œè¯¦æƒ…: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo ""
        echo "è¯·æ£€æŸ¥ä¸Šé¢çš„æ—¥å¿—äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        echo "å¦‚éœ€æ‰‹åŠ¨ä¿®å¤ï¼Œè¯·è®¿é—®GitHubä»“åº“çš„Actionsé¡µé¢"
